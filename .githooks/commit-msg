#!/bin/sh
#
# Conventional Commits validation hook
# https://www.conventionalcommits.org/

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Pattern for conventional commits
# type(optional scope)!: description (! indicates breaking change)
pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?: .+"

# Allow merge commits
if echo "$commit_msg" | grep -qE "^Merge "; then
    exit 0
fi

# Allow revert commits
if echo "$commit_msg" | grep -qE "^Revert "; then
    exit 0
fi

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "Expected format: <type>(<optional scope>): <description>"
    echo ""
    echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo ""
    echo "Version Bumps (Semantic Versioning):"
    echo "  PATCH (0.0.x) - fix: correct typo in keymap"
    echo "  MINOR (0.x.0) - feat: add new keyboard layer"
    echo "  MAJOR (x.0.0) - feat!: redesign entire keymap structure"
    echo "                - fix!: change default behavior"
    echo "                - Or include 'BREAKING CHANGE:' in commit body"
    echo ""
    echo "Examples:"
    echo "  fix: correct key mapping on layer 2"
    echo "  feat: add mouse keys support"
    echo "  feat(corne): add RGB underglow"
    echo "  feat!: switch to new layer system"
    echo "  docs: update build instructions"
    echo "  chore: update ZMK version"
    echo ""
    echo "Your message: $commit_msg"
    exit 1
fi

exit 0
